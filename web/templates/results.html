{% extends "_template.html" %}

{% block content1 %}
<div class="row justify-content-center">
  <div class="col-8 text-center">
    <h1 class="pt-5">Query:</h1>
  </div>
</div>
<div class="row justify-content-center">
  <div class="col-1 text-center">
    <h4>Modality:</h4> 
    {{modality}}
    <br>
    <br>
    <a class="btn btn-primary pt-3" role="button" href="/">Search Another</a>
  </div>
  <div class="col-4 text-center">
    <h4>Input:</h4>
    {% if modality == "text" %}
      {{query_input}}
    {% endif %}
    {% if modality == "image" %}
      <img height="100" src="{{query_input}}">
    {% endif %}
  </div>
  <div class="col-4 text-center">
    <h4>Relevant Tags:</h4>
    {% for tag in tags %}
      {{tag}}, 
    {% endfor%}
  </div>
</div>


<div class="row justify-content-center">
  <div class="col-3 text-center">
    <h1 class="pt-5">Results:</h1>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
    {% for result in results %}
      {% if result["modality"] == "image" %}
      <li class="nav-item">
        <a class="nav-link {% if loop.index0 == 0 %} active {% endif %}" id="results_{{loop.index0}}-tab" data-toggle="tab" href="#results_{{loop.index0}}" role="tab" aria-controls="results_{{loop.index0}}" aria-selected="true">{{result["dataset"]}}</a>
      </li>
      {% endif %}
    {% endfor %}
    </ul>
  </div>
  <div class="col-6">
    <canvas id="chart"></canvas>
  </div>
</div>

<div class="tab-content pt-5" id="myTabContent">
{% for result in results %}
  {% if result["modality"] == "image" %}
  <div class="tab-pane fade {% if loop.index0 == 0 %} show active {% endif %}" id="results_{{loop.index0}}" role="tabpanel" aria-labelledby="results_{{loop.index0}}-tab">
    <div class="row px-5">
      {% for j in range(result["num_results"])%}
      <div class="col-2">
        <a target="_blank" href="{{engine_url}}/{{result['data'][j]}}">
          <img class="w-100" src="{{engine_url}}/{{result['data'][j]}}">
        </a>
        <br>
        <div>
          Distance: {{result['dis'][j]}}
        </div>
        <form action="/query/dataset" method="POST">
          <div class="form-group d-none">
            <input name="query_input" class="form-control" id="query_input_input" type="text" value="{{engine_url}}/{{result['data'][j]}}">
            <input name="dataset" class="form-control" id="dataset_input" type="text" value="{{result['dataset']}}">
            <input name="target" class="form-control" id="target_input" type="text" value="{{result['idx'][j]}}">
          </div>
          <button type="submit" class="btn btn-primary">Similar</button>
        </form>        
      </div>
      {% endfor %}
    </div>

  </div>
  {% endif %}
{% endfor %}
</div>
{% endblock %}

{% block content%}
<div id="content"></div>
{% endblock %}

{% block scripts %}
<script type="text/jsx" src="{{url_for('static', filename='js/results.js')}}"></script>
<script type="text/jsx">
  var element = <Content data="{{data}}"/>
  ReactDOM.render(element, document.getElementById("content"));
</script>
{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script>
  
  console.log({{ results[0]["dis"] }});

  var data = {
    labels: Array.from({length: {{num_results}}}, (v, k) => k+1),
    datasets: [{
      label: "nus-wide",
      backgroundColor: "rgba(255,99,132,0.2)",
      borderColor: "rgba(255,99,132,1)",
      borderWidth: 2,
      hoverBackgroundColor: "rgba(255,99,132,0.4)",
      hoverBorderColor: "rgba(255,99,132,1)",
      data: {{ results[0]["dis"] }},
    }]
  };

  var options = {
    maintainAspectRatio: false,
    scales: {
      yAxes: [{
        stacked: true,
        gridLines: {
          display: true,
          color: "rgba(255,99,132,0.2)"
        }
      }],
      xAxes: [{
        gridLines: {
          display: false
        }
      }]
    }
  };


  var myChart = Chart.Bar('chart', {
    options: options,
    data: data
  });
  
</script>


